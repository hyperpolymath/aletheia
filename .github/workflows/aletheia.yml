# Aletheia RSR Compliance Check
# This workflow verifies RSR Bronze-level compliance using Aletheia
#
# Usage: Copy this file to your repository's .github/workflows/ directory

name: RSR Compliance

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  rsr-compliance:
    name: RSR Bronze Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Aletheia
        run: cargo install aletheia || cargo install --git https://gitlab.com/maa-framework/6-the-foundation/aletheia.git

      - name: Run RSR Compliance Check
        run: aletheia --format json > aletheia-report.json

      - name: Display Results
        run: |
          echo "## RSR Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if jq -e '.bronze_compliant == true and .has_critical_warnings == false' aletheia-report.json > /dev/null; then
            echo "✅ **Bronze-level RSR compliance: ACHIEVED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Bronze-level RSR compliance: NOT MET**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Score" >> $GITHUB_STEP_SUMMARY
          PASSED=$(jq '.score.passed' aletheia-report.json)
          TOTAL=$(jq '.score.total' aletheia-report.json)
          PCT=$(jq '.score.percentage' aletheia-report.json)
          echo "$PASSED/$TOTAL checks passed ($PCT%)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: aletheia-report
          path: aletheia-report.json

      - name: Fail on Non-Compliance
        run: |
          if ! jq -e '.bronze_compliant == true and .has_critical_warnings == false' aletheia-report.json > /dev/null; then
            echo "RSR Bronze compliance not met"
            exit 1
          fi
